<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAT TKA Matematika SD - Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f1f5f9; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .fraction { display: inline-block; text-align: center; vertical-align: middle; margin: 0 0.2em; font-size: 1.1em; font-weight: bold; color: #2563eb; }
        .fraction > span { display: block; padding: 0.1em; }
        .fraction span.numerator { border-bottom: 2px solid currentColor; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media print {
            body { background: white !important; }
            header, footer, #custom-modal, #status-indicator, button, .no-print { display: none !important; }
            #result-screen { display: block !important; position: relative; border: none; box-shadow: none; }
        }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">

    <header class="bg-white shadow-md border-b border-blue-100 sticky top-0 z-20">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg font-bold text-xl shadow-lg">CAT</div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">TKA Matematika Online</h1>
                    <p class="text-xs text-slate-500 font-semibold">Sistem Ujian Online</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="status-indicator" class="flex items-center gap-2 px-3 py-1 rounded-full bg-gray-100 border border-gray-200">
                    <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-400"></div>
                    <span id="status-text" class="text-xs font-bold text-gray-500">Connecting...</span>
                </div>
                <div id="user-info-display" class="hidden text-right">
                    <div id="display-name" class="font-bold text-sm text-blue-700">Peserta</div>
                    <div id="display-code" class="text-xs text-slate-500">Kode: -</div>
                </div>
                <div id="timer-display" class="hidden font-mono font-bold text-xl text-red-600 bg-red-50 px-3 py-1 rounded-md border border-red-200 shadow-inner">60:00</div>
            </div>
        </div>
    </header>

    <main class="flex-grow p-4 flex flex-col items-center justify-center min-h-[80vh]">
        <!-- 1. LOGIN SCREEN -->
        <div id="login-screen" class="w-full max-w-md glass-panel p-8 rounded-2xl shadow-xl border border-white fade-in">
            <div class="text-center mb-6">
                <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold">Login Peserta</h2>
                <p class="text-slate-500 text-sm">Gunakan kredensial otomatis berikut.</p>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-5 mb-6 text-center">
                <div class="grid grid-cols-2 gap-4 divide-x divide-blue-200">
                    <div>
                        <div class="text-xs text-slate-500 uppercase font-bold mb-1">Kode Peserta</div>
                        <div id="gen-code" class="text-2xl font-mono font-black text-blue-800">...</div>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase font-bold mb-1">Sandi</div>
                        <div id="gen-pass" class="text-2xl font-mono font-black text-blue-800">...</div>
                    </div>
                </div>
            </div>
            <button onclick="app.handleLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95">MASUK</button>
        </div>

        <!-- 2. DATA ENTRY -->
        <div id="confirmation-screen" class="hidden w-full max-w-4xl glass-panel p-8 rounded-2xl shadow-xl border border-white fade-in">
            <h2 class="text-2xl font-bold mb-6 border-b pb-2">Konfirmasi Data Peserta</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kode Peserta</label>
                        <input type="text" id="input-conf-code" class="w-full px-4 py-2 rounded-lg bg-slate-100 border font-bold" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Nama Lengkap</label>
                        <input type="text" id="input-name" class="w-full px-4 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Jenis Kelamin</label>
                        <select id="input-gender" class="w-full px-4 py-2 rounded-lg border bg-white">
                            <option value="">-- Pilih --</option>
                            <option value="Laki-laki">Laki-laki</option>
                            <option value="Perempuan">Perempuan</option>
                        </select>
                    </div>
                </div>
                <div class="flex flex-col justify-center gap-6">
                    <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-center">
                        <div class="text-xs text-yellow-700 font-bold mb-2">TOKEN AKTIF</div>
                        <div id="token-display" class="text-4xl font-mono font-black tracking-widest bg-white py-3 rounded-lg border">-----</div>
                    </div>
                    <div>
                         <input type="text" id="input-token" class="w-full px-4 py-3 rounded-lg border-2 border-slate-300 focus:border-blue-500 text-center text-xl tracking-widest uppercase" placeholder="KETIK TOKEN">
                    </div>
                </div>
            </div>
            <div class="mt-8 flex gap-3 border-t pt-6">
                <button onclick="location.reload()" class="flex-1 bg-white border py-3 rounded-xl font-bold">Batal</button>
                <button onclick="app.confirmData()" class="flex-[2] bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg">MULAI UJIAN</button>
            </div>
        </div>

        <!-- 3. QUIZ SCREEN -->
        <div id="quiz-screen" class="hidden w-full max-w-5xl glass-panel rounded-2xl shadow-xl border overflow-hidden fade-in flex flex-col md:flex-row">
            <div class="flex-grow p-6 md:p-10 border-r border-slate-200">
                <div class="flex justify-between items-center mb-6">
                    <div id="category-badge" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-bold uppercase">Matematika</div>
                    <div id="question-progress" class="font-bold text-slate-500">Soal 1/30</div>
                </div>
                <div id="question-text" class="text-xl text-slate-800 mb-8 leading-relaxed"></div>
                <div id="visual-container" class="mb-8 hidden flex justify-center"></div>
                <div id="options-container" class="grid grid-cols-1 gap-4"></div>
                <div class="flex justify-between mt-10 pt-6 border-t">
                    <button onclick="app.prevQuestion()" id="btn-prev" class="px-6 py-3 rounded-xl bg-slate-100 font-bold disabled:opacity-30">Kembali</button>
                    <button onclick="app.nextQuestion()" id="btn-next" class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-md">Berikutnya</button>
                </div>
            </div>
            <div class="w-full md:w-72 bg-slate-50 p-6 flex flex-col">
                <h3 class="text-center text-xs font-bold text-slate-400 uppercase mb-4">Navigasi Soal</h3>
                <div id="nav-grid" class="grid grid-cols-5 gap-2 mb-6"></div>
                <button onclick="app.finishQuiz()" class="mt-auto w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl">SELESAI</button>
            </div>
        </div>

        <!-- 4. RESULT -->
        <div id="result-screen" class="hidden w-full max-w-3xl glass-panel rounded-2xl shadow-xl p-8 fade-in text-center">
            <h2 class="text-3xl font-bold text-slate-800 mb-2">Hasil Ujian</h2>
            <p class="text-slate-500 mb-8">Nilai Anda telah tercatat di sistem.</p>
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-2xl p-8 mb-8 shadow-lg">
                <div class="text-sm font-bold opacity-70 uppercase">Skor Akhir</div>
                <div id="final-score" class="text-7xl font-black my-2">0</div>
                <div class="text-lg">Benar: <span id="correct-count">0</span> / 30</div>
            </div>
            <div class="text-left mb-8">
                <h3 class="font-bold text-xl mb-4 flex items-center gap-2">Peringkat Live</h3>
                <div class="bg-white rounded-xl border overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50">
                            <tr><th class="px-4 py-3">#</th><th class="px-4 py-3">Nama</th><th class="px-4 py-3 text-right">Skor</th></tr>
                        </thead>
                        <tbody id="leaderboard-body" class="divide-y">
                            <tr><td colspan="3" class="p-4 text-center">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="flex gap-4 no-print justify-center">
                <button onclick="window.print()" class="bg-slate-200 px-6 py-2 rounded-lg font-bold">Cetak</button>
                <button onclick="location.reload()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">Ulang</button>
            </div>
        </div>
    </main>

    <div id="custom-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-sm w-full p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4">Pesan</h3>
            <p id="modal-message" class="text-slate-600 mb-6"></p>
            <div id="modal-actions" class="flex justify-end gap-2"></div>
        </div>
    </div>

    <footer class="text-center py-6 text-slate-400 text-xs">CAT TKA Matematika SD Online &copy; 2024</footer>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // EXPOSE TO GLOBAL
        window.fb = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp };
        document.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script>
        // --- CONFIGURATION ---
        const MY_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBrW9-IE0yZc-aCp3IjwbCViaILGQbHUj8",
            authDomain: "tka-math-sd.firebaseapp.com",
            projectId: "tka-math-sd",
            storageBucket: "tka-math-sd.firebasestorage.app",
            messagingSenderId: "33767745712",
            appId: "1:33767745712:web:4a43a1144ad2203b78b375"
        };

        let db, auth;
        const APP_ID = "tka-math-v1";
        const COLLECTION_NAME = "scores";

        const Utils = {
            randInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
            randChoice: (arr) => arr[Math.floor(Math.random() * arr.length)],
            shuffle: (arr) => [...arr].sort(() => Math.random() - 0.5),
            gcd: (a, b) => b === 0 ? a : Utils.gcd(b, a % b),
            simplifyFraction: (n, d) => { const div = Utils.gcd(n, d); return [n/div, d/div]; },
            formatFraction: (n, d) => n===d ? "1" : (d===1 ? n : (n>d && n%d!==0 ? `${Math.floor(n/d)} <div class="fraction"><span class="numerator">${n%d}</span><span class="denominator">${d}</span></div>` : `<div class="fraction"><span class="numerator">${n}</span><span class="denominator">${d}</span></div>`))
        };

        const Generators = {
            fraction: () => {
                const d1 = Utils.randChoice([2, 3, 4, 5, 8]);
                const d2 = Utils.randChoice([2, 3, 4, 5, 8]);
                const n1 = Utils.randInt(1, d1-1);
                const n2 = Utils.randInt(1, d2-1);
                const isAdd = Math.random() > 0.5;
                const op = isAdd ? '+' : '-';
                
                let resN = isAdd ? (n1*d2 + n2*d1) : (n1*d2 - n2*d1);
                let resD = d1*d2;
                if(resN <= 0) { resN = (n1*d2 + n2*d1); } // Force positive

                const [sN, sD] = Utils.simplifyFraction(resN, resD);
                const ans = Utils.formatFraction(sN, sD);
                
                let opts = new Set([ans]);
                while(opts.size < 4) opts.add(Utils.formatFraction(Utils.randInt(1, 10), Utils.randChoice([2,3,4,5,8])));
                
                return { 
                    cat: "Bilangan", 
                    q: `Hasil dari ${Utils.formatFraction(n1,d1)} ${isAdd?'+':'-'} ${Utils.formatFraction(n2,d2)} adalah...`, 
                    ans: ans, 
                    opts: Utils.shuffle(Array.from(opts)) 
                };
            },
            geometry: () => {
                const p = Utils.randInt(5, 15);
                const l = Utils.randInt(2, 8);
                const isArea = Math.random() > 0.5;
                const ans = isArea ? `${p*l} cm²` : `${2*(p+l)} cm`;
                const q = `Sebuah persegi panjang memiliki panjang ${p} cm dan lebar ${l} cm. Berapakah ${isArea?'luas':'keliling'}nya?`;
                let opts = new Set([ans]);
                while(opts.size < 4) opts.add(`${Utils.randInt(10, 50)} cm${isArea?'²':''}`);
                return { cat: "Geometri", q: q, ans: ans, opts: Utils.shuffle(Array.from(opts)) };
            }
        };

        const app = {
            user: { name: '', code: '', token: '' },
            questions: [],
            answers: [],
            currIdx: 0,
            time: 3600,
            timer: null,
            isOffline: false,

            init: async () => {
                const dot = document.getElementById('status-dot');
                const txt = document.getElementById('status-text');
                
                try {
                    const firebaseApp = fb.initializeApp(MY_FIREBASE_CONFIG);
                    auth = fb.getAuth(firebaseApp);
                    db = fb.getFirestore(firebaseApp);
                    
                    await fb.signInAnonymously(auth);
                    
                    dot.className = "w-2 h-2 rounded-full bg-green-500";
                    txt.innerText = "Online";
                } catch (e) {
                    console.warn("Firebase offline", e);
                    app.isOffline = true;
                    txt.innerText = "Offline Mode";
                }
                app.initCredentials();
            },

            initCredentials: () => {
                const codes = ['TKA-101', 'TKA-102', 'TKA-201', 'TKA-202'];
                app.user.code = Utils.randChoice(codes);
                app.user.pass = Math.random().toString(36).slice(-4).toUpperCase();
                document.getElementById('gen-code').innerText = app.user.code;
                document.getElementById('gen-pass').innerText = app.user.pass;
            },

            handleLogin: () => {
                app.user.token = Math.random().toString(36).substring(2, 6).toUpperCase();
                document.getElementById('input-conf-code').value = app.user.code;
                document.getElementById('token-display').innerText = app.user.token;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('confirmation-screen').classList.remove('hidden');
            },

            confirmData: () => {
                const name = document.getElementById('input-name').value.trim();
                const token = document.getElementById('input-token').value.trim().toUpperCase();
                if(!name || token !== app.user.token) {
                    return app.showModal("Nama harus diisi dan Token harus benar!");
                }
                app.user.name = name;
                document.getElementById('display-name').innerText = name;
                document.getElementById('display-code').innerText = app.user.code;
                document.getElementById('confirmation-screen').classList.add('hidden');
                document.getElementById('quiz-screen').classList.remove('hidden');
                document.getElementById('user-info-display').classList.remove('hidden');
                document.getElementById('timer-display').classList.remove('hidden');
                app.startQuiz();
            },

            startQuiz: () => {
                app.questions = [];
                for(let i=0; i<15; i++) app.questions.push(Generators.fraction());
                for(let i=0; i<15; i++) app.questions.push(Generators.geometry());
                app.questions = Utils.shuffle(app.questions);
                app.answers = new Array(30).fill(null);
                
                app.renderNav();
                app.loadQ(0);
                
                app.timer = setInterval(() => {
                    app.time--;
                    const m = Math.floor(app.time/60);
                    const s = app.time%60;
                    document.getElementById('timer-display').innerText = `${m}:${s<10?'0'+s:s}`;
                    if(app.time <= 0) app.finishQuiz();
                }, 1000);
            },

            loadQ: (idx) => {
                app.currIdx = idx;
                const q = app.questions[idx];
                document.getElementById('question-progress').innerText = `Soal ${idx+1}/30`;
                document.getElementById('question-text').innerHTML = q.q;
                
                const container = document.getElementById('options-container');
                container.innerHTML = '';
                q.opts.forEach(opt => {
                    const btn = document.createElement('button');
                    const active = app.answers[idx] === opt;
                    btn.className = `w-full text-left p-4 rounded-xl border-2 transition ${active ? 'border-blue-600 bg-blue-50' : 'border-slate-200 bg-white'}`;
                    btn.innerHTML = opt;
                    btn.onclick = () => { app.answers[idx] = opt; app.loadQ(idx); app.updateNav(); };
                    container.appendChild(btn);
                });
                
                document.getElementById('btn-prev').disabled = idx === 0;
                const nextBtn = document.getElementById('btn-next');
                nextBtn.innerText = idx === 29 ? "Selesai" : "Berikutnya";
                nextBtn.onclick = idx === 29 ? app.finishQuiz : app.nextQuestion;
                app.updateNav();
            },

            nextQuestion: () => app.loadQ(app.currIdx + 1),
            prevQuestion: () => app.loadQ(app.currIdx - 1),

            renderNav: () => {
                const grid = document.getElementById('nav-grid');
                grid.innerHTML = '';
                for(let i=0; i<30; i++) {
                    const b = document.createElement('button');
                    b.id = `nav-${i}`;
                    b.innerText = i+1;
                    b.className = "h-10 w-10 rounded-lg font-bold text-xs border";
                    b.onclick = () => app.loadQ(i);
                    grid.appendChild(b);
                }
            },

            updateNav: () => {
                for(let i=0; i<30; i++) {
                    const b = document.getElementById(`nav-${i}`);
                    b.className = `h-10 w-10 rounded-lg font-bold text-xs transition ${i === app.currIdx ? 'ring-2 ring-blue-600 bg-white' : (app.answers[i] ? 'bg-blue-600 text-white' : 'bg-slate-200')}`;
                }
            },

            finishQuiz: () => {
                app.showModal("Kirim jawaban sekarang?", "confirm", async () => {
                    clearInterval(app.timer);
                    let correct = 0;
                    app.questions.forEach((q, i) => { if(app.answers[i] === q.ans) correct++; });
                    const score = Math.round((correct/30)*100);
                    
                    document.getElementById('quiz-screen').classList.add('hidden');
                    document.getElementById('result-screen').classList.remove('hidden');
                    document.getElementById('final-score').innerText = score;
                    document.getElementById('correct-count').innerText = correct;
                    
                    if(!app.isOffline) {
                        await fb.addDoc(fb.collection(db, COLLECTION_NAME), {
                            name: app.user.name,
                            score: score,
                            timestamp: fb.serverTimestamp()
                        });
                        app.loadLeaderboard();
                    }
                });
            },

            loadLeaderboard: () => {
                const q = fb.query(fb.collection(db, COLLECTION_NAME), fb.orderBy("score", "desc"), fb.limit(10));
                fb.onSnapshot(q, (snap) => {
                    const body = document.getElementById('leaderboard-body');
                    body.innerHTML = '';
                    let r = 1;
                    snap.forEach(doc => {
                        const d = doc.data();
                        body.innerHTML += `<tr><td class="px-4 py-3">${r++}</td><td class="px-4 py-3 font-bold">${d.name}</td><td class="px-4 py-3 text-right text-blue-600 font-black">${d.score}</td></tr>`;
                    });
                });
            },

            showModal: (msg, type="alert", cb) => {
                const m = document.getElementById('custom-modal');
                document.getElementById('modal-message').innerText = msg;
                const act = document.getElementById('modal-actions');
                act.innerHTML = '';
                
                const ok = document.createElement('button');
                ok.className = "bg-blue-600 text-white px-4 py-2 rounded-lg";
                ok.innerText = "OK";
                ok.onclick = () => { m.classList.add('hidden'); if(cb) cb(); };
                
                if(type === "confirm") {
                    const can = document.createElement('button');
                    can.className = "bg-slate-200 px-4 py-2 rounded-lg";
                    can.innerText = "Batal";
                    can.onclick = () => m.classList.add('hidden');
                    act.appendChild(can);
                }
                act.appendChild(ok);
                m.classList.remove('hidden');
            }
        };

        document.addEventListener('firebase-ready', app.init);
    </script>
</body>
</html>
