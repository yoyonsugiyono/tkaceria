<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAT TKA Bahasa Indonesia SD - Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global scope access for app logic
        window.firebaseModules = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp };
    </script>

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #fff7ed; } /* Orange tint for Indo */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        /* Text Reading Styling */
        .reading-text { 
            font-family: 'Georgia', serif; 
            line-height: 1.8; 
            color: #334155; 
            background: #fff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            border-left: 4px solid #f97316;
            margin-bottom: 1.5rem;
            font-size: 1.05rem;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #f97316; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* PRINT STYLES */
        @media print {
            body { background: white !important; color: black !important; }
            body * { visibility: hidden; }
            #result-screen, #result-screen * { visibility: visible; }
            #result-screen { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; box-shadow: none !important; border: none !important; background: white !important; }
            #result-screen button { display: none !important; }
            #final-score { color: black !important; border: 2px solid black; border-radius: 10px; padding: 10px; }
            header, footer, #custom-modal, #status-indicator { display: none !important; }
        }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col bg-[url('https://www.transparenttextures.com/patterns/notebook.png')]">

    <!-- Header -->
    <header class="bg-white shadow-md border-b border-orange-100 sticky top-0 z-20">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-orange-600 text-white p-2 rounded-lg font-bold text-xl shadow-lg">CAT</div>
                <div>
                    <h1 class="font-bold text-lg leading-tight text-slate-800">TKA Bahasa Indonesia</h1>
                    <p class="text-xs text-slate-500 font-semibold">Literasi Membaca SD</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <!-- Status Indicator -->
                <div id="status-indicator" class="flex items-center gap-2 px-3 py-1 rounded-full bg-gray-100 border border-gray-200">
                    <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-400"></div>
                    <span id="status-text" class="text-xs font-bold text-gray-500">Connecting...</span>
                </div>

                <div id="user-info-display" class="hidden text-right">
                    <div id="display-name" class="font-bold text-sm text-orange-700">Peserta</div>
                    <div id="display-code" class="text-xs text-slate-500">Kode: -</div>
                </div>
                <div id="timer-display" class="hidden font-mono font-bold text-xl text-red-600 bg-red-50 px-3 py-1 rounded-md border border-red-200 shadow-inner">
                    60:00
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 flex flex-col items-center justify-center min-h-[80vh]">
        
        <!-- 1. LOGIN SCREEN -->
        <div id="login-screen" class="w-full max-w-md glass-panel p-8 rounded-2xl shadow-xl border border-white fade-in">
            <div class="text-center mb-6">
                <div class="bg-orange-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-slate-800">Login Peserta</h2>
                <p class="text-slate-500 text-sm">Masuk untuk memulai ujian literasi.</p>
            </div>

            <div class="bg-orange-50 border border-orange-200 rounded-xl p-5 mb-6 text-center relative overflow-hidden">
                <div class="absolute top-0 right-0 bg-orange-500 text-white text-[10px] px-2 py-1 rounded-bl-lg font-bold">AUTO</div>
                <div class="grid grid-cols-2 gap-4 divide-x divide-orange-200">
                    <div>
                        <div class="text-xs text-slate-500 uppercase font-bold mb-1">Kode Peserta</div>
                        <div id="gen-code" class="text-2xl font-mono font-black text-orange-800 tracking-tight">...</div>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase font-bold mb-1">Sandi</div>
                        <div id="gen-pass" class="text-2xl font-mono font-black text-orange-800 tracking-tight">...</div>
                    </div>
                </div>
            </div>

            <button onclick="app.handleLogin()" id="btn-login" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95">
                MASUK
            </button>
        </div>

        <!-- 2. DATA CONFIRMATION -->
        <div id="confirmation-screen" class="hidden w-full max-w-4xl glass-panel p-8 rounded-2xl shadow-xl border border-white fade-in">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 border-b pb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Data Diri Peserta
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kode Peserta</label>
                        <input type="text" id="input-conf-code" class="w-full px-4 py-2 rounded-lg bg-slate-100 border border-slate-300 text-slate-600 font-bold" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Nama Peserta <span class="text-red-500">*</span></label>
                        <input type="text" id="input-name" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition" placeholder="Masukkan nama lengkap">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Jenis Kelamin <span class="text-red-500">*</span></label>
                        <select id="input-gender" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition bg-white">
                            <option value="">-- Pilih Jenis Kelamin --</option>
                            <option value="Laki-laki">Laki-laki</option>
                            <option value="Perempuan">Perempuan</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Tanggal Lahir <span class="text-red-500">*</span></label>
                        <input type="date" id="input-dob" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition">
                    </div>
                </div>

                <div class="flex flex-col justify-center gap-6">
                    <div class="bg-orange-50 p-4 rounded-xl border border-orange-200 text-center shadow-sm">
                        <div class="text-xs text-orange-700 font-bold mb-2">TOKEN SERVER (AKTIF)</div>
                        <div id="token-display" class="text-4xl font-mono font-black text-slate-800 tracking-widest bg-white px-2 py-3 rounded-lg border border-slate-200 select-all">
                            -----
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border-2 border-slate-100">
                         <label class="block text-sm font-bold text-slate-700 mb-2 text-center">Salin Token Ujian <span class="text-red-500">*</span></label>
                         <input type="text" id="input-token" class="w-full px-4 py-3 rounded-lg border-2 border-slate-300 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition font-mono text-center text-xl tracking-widest uppercase placeholder:text-slate-300 placeholder:text-sm" placeholder="KETIK TOKEN DI SINI">
                         <p class="text-xs text-slate-400 mt-2 text-center">Ketik ulang token yang tampil di atas untuk memulai.</p>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex gap-3 border-t pt-6">
                <button onclick="location.reload()" class="flex-1 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-bold py-3 rounded-xl transition">
                    Batal
                </button>
                <button onclick="app.confirmData()" class="flex-[2] bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95">
                    KONFIRMASI & MULAI
                </button>
            </div>
        </div>

        <!-- 3. QUIZ SCREEN -->
        <div id="quiz-screen" class="hidden w-full max-w-5xl glass-panel rounded-2xl shadow-xl border border-white overflow-hidden fade-in flex flex-col">
            <div class="bg-slate-100 p-4 border-b border-slate-200 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span id="category-badge" class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs font-bold uppercase">Bahasa Indonesia</span>
                    <span id="level-badge" class="bg-gray-200 text-gray-700 px-2 py-1 rounded text-xs font-bold uppercase tracking-wider">Loading...</span>
                </div>
                <div class="text-sm font-bold text-slate-600" id="question-progress">Soal 1/30</div>
            </div>

            <div class="flex flex-col md:flex-row">
                <div class="flex-grow p-6 md:p-8 h-[70vh] overflow-y-auto">
                    <!-- Stimulus / Reading Text -->
                    <div id="reading-container"></div>
                    
                    <!-- Question -->
                    <div id="question-text" class="text-lg font-bold text-slate-800 mb-6 leading-relaxed"></div>
                    
                    <!-- Options -->
                    <div id="options-container" class="grid grid-cols-1 gap-3"></div>

                    <!-- Navigation -->
                    <div class="flex justify-between items-center mt-10 pt-6 border-t border-slate-100">
                        <button onclick="app.prevQuestion()" id="btn-prev" class="flex items-center gap-2 px-6 py-3 rounded-xl bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                            Soal Sebelumnya
                        </button>
                        <button onclick="app.nextQuestion()" id="btn-next" class="flex items-center gap-2 px-6 py-3 rounded-xl bg-orange-600 text-white font-bold hover:bg-orange-700 transition shadow-md hover:shadow-lg">
                            Soal Berikutnya
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
                
                <!-- Sidebar Nav -->
                <div class="w-full md:w-64 bg-slate-50 border-l border-slate-200 p-4 h-full overflow-y-auto">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-3 text-center">Navigasi Soal</div>
                    <div id="nav-grid" class="grid grid-cols-5 gap-2"></div>
                    <button onclick="app.finishQuiz()" id="btn-submit-exam" class="mt-6 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg shadow transition">Selesai Ujian</button>
                </div>
            </div>
        </div>

        <!-- 4. RESULT SCREEN -->
        <div id="result-screen" class="hidden w-full max-w-4xl glass-panel rounded-2xl shadow-xl border border-white p-6 md:p-8 fade-in text-center">
            <div class="inline-block p-4 rounded-full bg-green-100 text-green-600 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
             </div>
            <h2 class="text-3xl font-bold text-slate-800">Ujian Selesai!</h2>
            <p class="text-slate-500 mb-8">Nilai Anda telah disimpan ke server.</p>

            <div class="bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-2xl p-6 mb-8 max-w-md mx-auto shadow-lg transform hover:scale-105 transition duration-300">
                <div class="text-sm font-semibold opacity-80 uppercase tracking-widest">Skor Perolehan</div>
                <div id="final-score" class="text-6xl font-extrabold my-2">0</div>
                <div class="text-sm opacity-90">Benar: <span id="correct-count">0</span> dari 30 Soal</div>
            </div>

            <div class="mt-8 text-left">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-xl text-slate-700 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                        Peringkat Peserta (Live)
                    </h3>
                    <div id="loading-leaderboard" class="loader hidden"></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 uppercase font-bold">
                                <tr>
                                    <th class="px-6 py-3">#</th>
                                    <th class="px-6 py-3">Nama Peserta</th>
                                    <th class="px-6 py-3">Kode</th>
                                    <th class="px-6 py-3 text-right">Skor</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-body" class="divide-y divide-slate-100">
                                <tr><td colspan="4" class="px-6 py-4 text-center text-slate-400 italic">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex gap-4 justify-center">
                 <button onclick="window.print()" class="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-bold py-2 px-6 rounded-lg transition">Cetak Hasil</button>
                <button onclick="location.reload()" class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-2 px-6 rounded-lg transition">Keluar / Login Ulang</button>
            </div>
        </div>

    </main>

    <!-- Modal -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform scale-100 transition-transform">
            <h3 class="text-lg font-bold text-slate-800 mb-2">Pemberitahuan</h3>
            <p id="modal-message" class="text-slate-600 mb-6 text-sm">Pesan...</p>
            <div class="flex justify-end gap-3" id="modal-actions"></div>
        </div>
    </div>

    <footer class="bg-white border-t border-slate-200 py-8 mt-auto">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <p class="text-slate-700 font-medium mb-3">
                &copy; 2026 Simulasi TKA Bahasa Indonesia SD Online.
            </p>
            <div class="border-t border-slate-100 pt-3 mt-3">
                <p class="text-xs text-slate-500 leading-relaxed">
                    Pengembang: <strong class="text-slate-700">Yoyon Sugiyono, S.Pd., M.Pd., Gr.</strong><br>
                    GPD Komunitas Belajar.id Kab. Sampang &bull; Guru Kelas di UPTD SDN Margantoko 2<br>
                    <span class="inline-flex items-center gap-1 mt-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                        Informasi Kontak: 082331769605
                    </span>
                </p>
            </div>
        </div>
    </footer>

    <!-- APP LOGIC -->
    <script>
        const USER_FIREBASE_CONFIG = {}; // Isi config firebase di sini jika di-deploy

        let db, auth, appId;
        const COLLECTION_NAME = 'tka_indo_scores';

        async function initFirebase() {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');

            try {
                const { initializeApp, getAuth, signInAnonymously, getFirestore, signInWithCustomToken } = window.firebaseModules;
                
                let firebaseConfig = null;
                appId = 'tka-indo-app';

                if (typeof window.__firebase_config !== 'undefined' && window.__firebase_config) {
                    firebaseConfig = JSON.parse(window.__firebase_config);
                    appId = typeof window.__app_id !== 'undefined' ? window.__app_id : appId;
                } else if (USER_FIREBASE_CONFIG.apiKey) {
                    firebaseConfig = USER_FIREBASE_CONFIG;
                }

                if (!firebaseConfig) throw new Error("No config found");
                
                const firebaseApp = initializeApp(firebaseConfig);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);

                if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                    await signInWithCustomToken(auth, window.__initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                console.log("Firebase Connected");
                statusDot.className = "w-2 h-2 rounded-full bg-green-500";
                statusText.innerText = "Online";
                statusText.className = "text-xs font-bold text-green-500";

                if (typeof app !== 'undefined' && app.initCredentials) app.initCredentials();
                
            } catch (e) {
                console.error("Firebase Error:", e);
                app.isOffline = true;
                statusDot.className = "w-2 h-2 rounded-full bg-orange-500";
                statusText.innerText = "Mode Offline";
                statusText.className = "text-xs font-bold text-orange-500";
                if (typeof app !== 'undefined' && app.initCredentials) app.initCredentials();
            }
        }

        // --- GENERATOR SOAL BAHASA INDONESIA ---
        const Utils = {
            randInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
            randChoice: (arr) => arr[Math.floor(Math.random() * arr.length)],
            shuffle: (array) => array.sort(() => Math.random() - 0.5)
        };

        const Texts = {
            fiksi: [
                {
                    title: "Kenthus yang Sombong",
                    content: "Di tengah padang rumput terdapat kolam. Kolam itu dihuni banyak katak. Kenthus adalah anak katak yang paling besar dan kuat. Dia merasa tidak terkalahkan. Suatu pagi, Kenthus melihat seekor anak lembu. 'Berani makhluk ini mengusikku!' kata Kenthus dengan sombong. Koko, kakaknya, menasihati, 'Makhluk itu anak lembu. Ia tidak jahat.' Namun Kenthus tidak percaya. Ia mencoba mengembungkan badannya agar sebesar lembu. Tiba-tiba ia jatuh lemas karena perutnya sakit. Akhirnya Kenthus sadar dan meminta maaf.",
                    source: "Fabel Nusantara"
                },
                {
                    title: "Surat untuk Sahabat",
                    content: "Senyum itu enggan lepas dari bibirmu, ketika kau melihat kedatanganku. Uluran tanganmu menyambutku, untuk selalu bersama dan saling berpegang erat. Menghadapi segala suka maupun duka. Bila sesekali kau marah, itu karena aku tak mau memahamimu. Kata terima kasih kuanggap lebih manis daripada kata maaf. Untuk segala keceriaan yang selalu kau bagi. Satu harapku dalam hati, kata persahabatan tidak akan pernah menjadi sebuah kenangan.",
                    source: "Puisi Anak"
                },
                {
                    title: "Danau untuk Semua",
                    content: "Di hutan ada sebuah danau tempat semua binatang minum. Suatu pagi, air danau menjadi kotor karena Rino si badak berendam di dalamnya. Binatang lain tidak bisa minum. Mereka takut menegur Rino karena badannya besar. Esoknya, Rino masih berendam. Ucil si Kancil akhirnya punya ide. Ia berkata pada Rino bahwa ada makhluk gaib yang menutup air. Rino percaya dan pergi mengawasi pohon nangka seharian. Saat Rino pergi, binatang lain akhirnya bisa minum sepuasnya.",
                    source: "Fabel Inspiratif"
                }
            ],
            informasi: [
                {
                    title: "Hewan Pemakan Daun",
                    content: "Hewan bisa dibagi menjadi tiga kelompok berdasarkan makanannya: karnivora, herbivora, dan omnivora. Dari kelompok herbivora, ada hewan yang hanya makan daun saja, disebut folivora. Daun susah dicerna, jadi hewan folivora punya usus panjang dan bakteri khusus di perutnya. Contoh hewan folivora adalah koala yang makan daun eukaliptus dan panda yang makan bambu. Hutan tempat mereka tinggal harus dijaga agar mereka bisa terus hidup.",
                    source: "Bobo.grid.id"
                },
                {
                    title: "Pentingnya Menyikat Gigi",
                    content: "Kenapa kita tidak boleh malas menyikat gigi? Gigi kita terdiri dari lapisan enamel, dentin, dan pulpa. Lapisan enamel sangat keras, tapi jika rusak tidak bisa memperbaiki diri. Jika kita malas sikat gigi, bakteri jahat akan memakan sisa gula di gigi kita. Bakteri itu melepaskan asam yang membuat gigi berlubang. Bayangkan jika tidak punya gigi, kita hanya bisa makan bubur. Jadi, ayo rajin sikat gigi sebelum tidur!",
                    source: "Info Kesehatan Anak"
                },
                {
                    title: "Kerupuk Mendunia",
                    content: "Kerupuk bukan hal asing bagi masyarakat Indonesia. Teksturnya renyah dan rasanya gurih. Ternyata kerupuk sudah ada sejak abad ke-9, tertulis di Prasasti Batu Pura. Kerupuk tertua adalah kerupuk rambak atau kulit. Kini kerupuk Indonesia sudah diekspor ke luar negeri dengan nilai jutaan dolar. Ada kerupuk udang, bawang, hingga kerupuk gendar.",
                    source: "Sejarah Kuliner"
                }
            ]
        };

        const Generators = {
            // Pemahaman Tekstual (LOTS)
            textualInfo: () => {
                const type = Math.random() > 0.5 ? 'fiksi' : 'informasi';
                const textData = Utils.randChoice(Texts[type]);
                let question, ans, distractors;

                if (textData.title === "Kenthus yang Sombong") {
                    question = "Siapakah nama kakak Kenthus dalam cerita tersebut?";
                    ans = "Koko";
                    distractors = ["Kenthus", "Lembu", "Tata"];
                } else if (textData.title === "Hewan Pemakan Daun") {
                    question = "Disebut apakah hewan yang hanya memakan daun saja?";
                    ans = "Folivora";
                    distractors = ["Karnivora", "Omnivora", "Insectivora"];
                } else if (textData.title === "Surat untuk Sahabat") {
                    question = "Apa yang dilakukan sahabat 'aku' ketika melihat kedatangannya?";
                    ans = "Tersenyum dan mengulurkan tangan";
                    distractors = ["Marah dan diam saja", "Pergi menjauh", "Menangis tersedu-sedu"];
                } else {
                    // Generic fallback
                    question = "Apa topik utama yang dibahas dalam teks di atas?";
                    ans = textData.title;
                    distractors = ["Kesehatan Tubuh", "Sejarah Dunia", "Teknologi Modern"];
                }

                return {
                    cat: "Pemahaman Tekstual",
                    level: "LOTS",
                    q: `<div class="reading-text"><h3 class="font-bold mb-2">${textData.title}</h3>${textData.content}</div><div class="font-bold text-lg">${question}</div>`,
                    ans: ans,
                    opts: Utils.shuffle([ans, ...distractors])
                };
            },

            // Pemahaman Inferensial (MOTS)
            inferential: () => {
                const type = Math.random() > 0.5 ? 'fiksi' : 'informasi';
                const textData = Utils.randChoice(Texts[type]);
                let question, ans, distractors;

                if (textData.title === "Kenthus yang Sombong") {
                    question = "Mengapa Kenthus akhirnya meminta maaf kepada kakaknya?";
                    ans = "Karena ia sadar perbuatannya salah dan berbahaya.";
                    distractors = ["Karena ia takut dimakan oleh anak lembu.", "Karena ia berhasil mengalahkan anak lembu.", "Karena ia ingin dipuji oleh teman-temannya."];
                } else if (textData.title === "Pentingnya Menyikat Gigi") {
                    question = "Apa yang mungkin terjadi jika lapisan enamel gigi kita rusak?";
                    ans = "Gigi akan terasa sakit atau nyut-nyutan saat terkena suhu panas/dingin.";
                    distractors = ["Gigi akan tumbuh kembali dengan sendirinya.", "Gigi menjadi lebih kuat dan putih.", "Kita bisa memakan makanan yang lebih keras."];
                } else {
                    question = "Berdasarkan teks, apa simpulan yang paling tepat?";
                    ans = "Informasi dalam teks sangat bermanfaat bagi pengetahuan kita.";
                    distractors = ["Teks tersebut tidak memiliki makna.", "Penulis tidak menyukai topik tersebut.", "Cerita berakhir menyedihkan."];
                }

                return {
                    cat: "Pemahaman Inferensial",
                    level: "MOTS",
                    q: `<div class="reading-text"><h3 class="font-bold mb-2">${textData.title}</h3>${textData.content}</div><div class="font-bold text-lg">${question}</div>`,
                    ans: ans,
                    opts: Utils.shuffle([ans, ...distractors])
                };
            },

            // Evaluasi dan Apresiasi (HOTS)
            evaluation: () => {
                const type = Math.random() > 0.5 ? 'fiksi' : 'informasi';
                const textData = Utils.randChoice(Texts[type]);
                let question, ans, distractors;

                if (textData.title === "Danau untuk Semua") {
                    question = "Apakah tindakan Ucil membohongi Rino dapat dibenarkan? Mengapa?";
                    ans = "Ya, karena itu cara cerdik untuk menyelamatkan kepentingan banyak hewan tanpa kekerasan.";
                    distractors = [
                        "Tidak, karena berbohong itu perbuatan tercela dalam kondisi apapun.",
                        "Ya, karena Rino adalah hewan yang jahat dan pantas dihukum mati.",
                        "Tidak, seharusnya Ucil mengajak hewan lain untuk menyerang Rino bersama-sama."
                    ];
                } else if (textData.title === "Kerupuk Mendunia") {
                    question = "Apa bukti bahwa kerupuk bukan sekadar makanan pelengkap biasa?";
                    ans = "Nilai ekspornya mencapai jutaan dolar dan sudah ada sejak abad ke-9.";
                    distractors = [
                        "Kerupuk memiliki rasa yang gurih dan renyah.",
                        "Kerupuk mudah ditemukan di warung-warung.",
                        "Kerupuk bisa dibuat dari bahan sisa nasi."
                    ];
                } else {
                    question = "Pelajaran berharga apa yang bisa diambil dari teks di atas untuk kehidupan sehari-hari?";
                    ans = "Kita harus menjaga sikap dan kesehatan diri/lingkungan.";
                    distractors = ["Kita harus menjadi yang paling kuat.", "Makanan enak adalah segalanya.", "Menangis adalah solusi masalah."];
                }

                return {
                    cat: "Evaluasi & Apresiasi",
                    level: "HOTS",
                    q: `<div class="reading-text"><h3 class="font-bold mb-2">${textData.title}</h3>${textData.content}</div><div class="font-bold text-lg">${question}</div>`,
                    ans: ans,
                    opts: Utils.shuffle([ans, ...distractors])
                };
            }
        };

        const app = {
            user: { code: '', name: '', gender: '', dob: '', token: '' },
            questions: [],
            answers: [],
            currIdx: 0,
            timer: null,
            time: 3600,
            isOffline: false,
            generatedCreds: { code: '', pass: '' },

            showModal: (msg, type = 'alert', callback = null) => {
                const modal = document.getElementById('custom-modal');
                const msgEl = document.getElementById('modal-message');
                const actionsEl = document.getElementById('modal-actions');
                msgEl.innerHTML = msg;
                actionsEl.innerHTML = '';
                if (type === 'confirm') {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = "px-4 py-2 rounded-lg bg-slate-200 text-slate-700 font-bold hover:bg-slate-300";
                    cancelBtn.innerText = "Batal";
                    cancelBtn.onclick = () => modal.classList.add('hidden');
                    const okBtn = document.createElement('button');
                    okBtn.className = "px-4 py-2 rounded-lg bg-orange-600 text-white font-bold hover:bg-orange-700";
                    okBtn.innerText = "Ya, Yakin";
                    okBtn.onclick = () => { modal.classList.add('hidden'); if (callback) callback(); };
                    actionsEl.appendChild(cancelBtn);
                    actionsEl.appendChild(okBtn);
                } else {
                    const okBtn = document.createElement('button');
                    okBtn.className = "px-4 py-2 rounded-lg bg-orange-600 text-white font-bold hover:bg-orange-700";
                    okBtn.innerText = "OK";
                    okBtn.onclick = () => { modal.classList.add('hidden'); if (callback) callback(); };
                    actionsEl.appendChild(okBtn);
                }
                modal.classList.remove('hidden');
            },

            initCredentials: () => {
                const codes = ['INDO-001', 'BHS-042', 'LITERASI-88', 'PESERTA-12', 'BACA-07'];
                app.generatedCreds.code = `${codes[Math.floor(Math.random() * codes.length)]}`;
                app.generatedCreds.pass = Math.random().toString(36).slice(-6).toUpperCase();
                const codeElem = document.getElementById('gen-code');
                const passElem = document.getElementById('gen-pass');
                if (codeElem) codeElem.innerText = app.generatedCreds.code;
                if (passElem) passElem.innerText = app.generatedCreds.pass;
            },

            handleLogin: () => {
                app.user.code = app.generatedCreds.code;
                app.user.token = Math.random().toString(36).substring(2, 7).toUpperCase();
                document.getElementById('input-conf-code').value = app.user.code;
                document.getElementById('token-display').innerText = app.user.token;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('confirmation-screen').classList.remove('hidden');
            },

            confirmData: () => {
                const name = document.getElementById('input-name').value.trim();
                const gender = document.getElementById('input-gender').value;
                const dob = document.getElementById('input-dob').value;
                const manualToken = document.getElementById('input-token').value.trim().toUpperCase();
                if (!name || !gender || !dob) {
                    app.showModal("Mohon lengkapi Nama, Jenis Kelamin, dan Tanggal Lahir!", 'alert');
                    return;
                }
                if (manualToken !== app.user.token) {
                    app.showModal("Token Ujian tidak sesuai!", 'alert');
                    return;
                }
                app.user.name = name;
                app.user.gender = gender;
                app.user.dob = dob;
                document.getElementById('confirmation-screen').classList.add('hidden');
                document.getElementById('quiz-screen').classList.remove('hidden');
                document.getElementById('user-info-display').classList.remove('hidden');
                document.getElementById('display-name').innerText = app.user.name;
                document.getElementById('display-code').innerText = app.user.code;
                document.getElementById('timer-display').classList.remove('hidden');
                app.startQuiz();
            },

            generateQuestions: () => {
                app.questions = [];
                // Distibution: 10 Textual, 10 Inferential, 10 Evaluation
                for(let i=0; i<10; i++) app.questions.push(Generators.textualInfo());
                for(let i=0; i<10; i++) app.questions.push(Generators.inferential());
                for(let i=0; i<10; i++) app.questions.push(Generators.evaluation());
                
                app.questions = Utils.shuffle(app.questions);
                app.answers = new Array(30).fill(null);
            },

            startQuiz: () => {
                app.generateQuestions();
                app.renderNav();
                app.loadQ(0);
                app.timer = setInterval(() => {
                    app.time--;
                    const m = Math.floor(app.time/60);
                    const s = app.time%60;
                    document.getElementById('timer-display').innerText = `${m}:${s<10?'0'+s:s}`;
                    if(app.time <= 0) app.finishQuiz();
                }, 1000);
            },

            loadQ: (idx) => {
                app.currIdx = idx;
                const q = app.questions[idx];
                document.getElementById('question-progress').innerText = `Soal ${idx+1}/30`;
                document.getElementById('category-badge').innerText = q.cat;
                
                const lvlBadge = document.getElementById('level-badge');
                lvlBadge.innerText = q.level;
                if(q.level === 'LOTS') lvlBadge.className = "bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold uppercase tracking-wider border border-green-200";
                else if(q.level === 'MOTS') lvlBadge.className = "bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold uppercase tracking-wider border border-yellow-200";
                else lvlBadge.className = "bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold uppercase tracking-wider border border-red-200";

                const readingContainer = document.getElementById('reading-container');
                readingContainer.innerHTML = q.q.split('<div class="font-bold text-lg">')[0]; // Extract text part
                
                const questionText = q.q.match(/<div class="font-bold text-lg">(.+)<\/div>/)[1]; // Extract question part
                document.getElementById('question-text').innerHTML = questionText;

                const opts = document.getElementById('options-container');
                opts.innerHTML = '';
                const labels = ['A', 'B', 'C', 'D'];
                q.opts.forEach((opt, i) => {
                    const btn = document.createElement('button');
                    const isSel = app.answers[idx] === opt;
                    const label = labels[i] || '';
                    btn.className = `w-full text-left p-3 rounded-lg border-2 transition flex items-center gap-3 ${isSel ? 'border-orange-500 bg-orange-50' : 'border-slate-200 hover:border-orange-300 bg-white'}`;
                    btn.innerHTML = `<div class="flex-shrink-0 h-8 w-8 rounded-full ${isSel ? 'bg-orange-600 text-white' : 'bg-slate-100 text-slate-500'} flex items-center justify-center font-bold text-sm border ${isSel ? 'border-orange-600' : 'border-slate-300'}">${label}</div><span class="text-slate-700 font-medium">${opt}</span>`;
                    btn.onclick = () => { app.answers[idx] = opt; app.loadQ(idx); app.updateNav(); };
                    opts.appendChild(btn);
                });

                const prevBtn = document.getElementById('btn-prev');
                const nextBtn = document.getElementById('btn-next');
                if(prevBtn) prevBtn.disabled = idx === 0;
                
                if(nextBtn) {
                    nextBtn.onclick = null; 
                    if(idx === 29) {
                        nextBtn.innerHTML = `Selesai Ujian <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
                        nextBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
                        nextBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                        nextBtn.onclick = () => app.finishQuiz(); 
                    } else {
                        nextBtn.innerHTML = `Soal Berikutnya <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>`;
                        nextBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                        nextBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');
                        nextBtn.onclick = () => app.nextQuestion();
                    }
                }
                app.updateNav();
            },

            prevQuestion: () => { if(app.currIdx > 0) app.loadQ(app.currIdx - 1); },
            nextQuestion: () => { if(app.currIdx < 29) app.loadQ(app.currIdx + 1); },

            renderNav: () => {
                const grid = document.getElementById('nav-grid');
                grid.innerHTML = '';
                for(let i=0; i<30; i++) {
                    const btn = document.createElement('button');
                    btn.id = `nav-${i}`;
                    btn.innerText = i+1;
                    btn.className = `h-8 w-8 rounded text-xs font-bold bg-slate-200 text-slate-600`;
                    btn.onclick = () => app.loadQ(i);
                    grid.appendChild(btn);
                }
            },

            updateNav: () => {
                for(let i=0; i<30; i++) {
                    const btn = document.getElementById(`nav-${i}`);
                    btn.className = `h-8 w-8 rounded text-xs font-bold transition ${i === app.currIdx ? 'ring-2 ring-orange-500 bg-white' : (app.answers[i] ? 'bg-orange-600 text-white' : 'bg-slate-200 text-slate-600')}`;
                }
            },

            finishQuiz: () => {
                app.showModal("Apakah Anda yakin ingin menyelesaikan ujian ini?", 'confirm', async () => {
                    clearInterval(app.timer);
                    let correct = 0;
                    app.questions.forEach((q, i) => { if(app.answers[i] === q.ans) correct++; });
                    const score = Math.round((correct/30) * 100);
                    document.getElementById('quiz-screen').classList.add('hidden');
                    document.getElementById('result-screen').classList.remove('hidden');
                    document.getElementById('final-score').innerText = score;
                    document.getElementById('correct-count').innerText = correct;
                    if (!app.isOffline) {
                        await app.saveScore(score);
                        app.loadLeaderboard();
                    } else {
                        document.getElementById('leaderboard-body').innerHTML = '<tr><td colspan="4" class="p-4 text-center text-orange-500">Mode Offline.</td></tr>';
                    }
                });
            },

            saveScore: async (score) => {
                if(!db || !auth.currentUser) return;
                try {
                    const { collection, addDoc, serverTimestamp } = window.firebaseModules;
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), { code: app.user.code, name: app.user.name, score: score, timestamp: serverTimestamp() });
                } catch (e) { console.error("Save Error", e); }
            },

            loadLeaderboard: () => {
                if(!db) return;
                const { collection, query, orderBy, limit, onSnapshot } = window.firebaseModules;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), orderBy("score", "desc"), limit(20));
                document.getElementById('loading-leaderboard').classList.remove('hidden');
                onSnapshot(q, (snapshot) => {
                    const tbody = document.getElementById('leaderboard-body');
                    tbody.innerHTML = '';
                    let rank = 1;
                    if(snapshot.empty) tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center">Belum ada data.</td></tr>`;
                    snapshot.forEach((doc) => {
                        const d = doc.data();
                        const isMe = d.name === app.user.name && d.code === app.user.code;
                        const row = `<tr class="${isMe ? 'bg-yellow-50 border-l-4 border-yellow-400' : 'hover:bg-slate-50'} transition"><td class="px-6 py-4 font-bold text-slate-500">${rank++}</td><td class="px-6 py-4 font-semibold ${isMe ? 'text-blue-700' : 'text-slate-700'}">${d.name} ${isMe ? '(Anda)' : ''}</td><td class="px-6 py-4 text-slate-500 text-xs">${d.code}</td><td class="px-6 py-4 text-right font-bold text-blue-600">${d.score}</td></tr>`;
                        tbody.innerHTML += row;
                    });
                    document.getElementById('loading-leaderboard').classList.add('hidden');
                }, (error) => { console.error("Leaderboard Error:", error); });
            }
        };

        window.app = app;
        window.addEventListener('load', initFirebase);
    </script>
</body>
</html>
