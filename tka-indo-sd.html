<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAT TKA Bahasa Indonesia SD - Online (AI Generated)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        window.firebaseModules = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp };
        window.dispatchEvent(new Event('firebaseModulesLoaded'));
    </script>

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f0f9ff; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }

        /* Reading Text Box Styling */
        .reading-text {
            background-color: #f8fafc;
            border-left: 4px solid #3b82f6;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            font-size: 1rem;
            line-height: 1.8;
            color: #334155;
            max-height: 400px;
            overflow-y: auto;
            border-radius: 0.5rem;
            white-space: pre-wrap;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
        }

        /* Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* PRINT STYLES */
        @media print {
            body { background: white !important; color: black !important; }
            body * { visibility: hidden; }
            #result-screen, #result-screen * { visibility: visible; }
            #result-screen { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; box-shadow: none !important; border: none !important; background: white !important; }
            #result-screen button, #leaderboard-section { display: none !important; }
            #final-score { color: black !important; border: 2px solid black; border-radius: 10px; padding: 10px; }
            #discussion-section { display: block !important; margin-top: 20px; }
            header, footer, #custom-modal, #status-indicator { display: none !important; }
            .page-break { page-break-inside: avoid; border: 1px solid #ccc; margin-bottom: 10px; padding: 10px; border-radius: 5px; }
            .reading-text { max-height: none !important; overflow: visible !important; border: 1px solid #ddd; }
        }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">

    <!-- Header -->
    <header class="bg-white shadow-md border-b border-blue-100 sticky top-0 z-20">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg font-bold text-xl shadow-lg">CAT</div>
                <div>
                    <h1 class="font-bold text-lg leading-tight text-slate-800">TKA Bahasa Indonesia (AI)</h1>
                    <p class="text-xs text-slate-500 font-semibold">Sistem Ujian Adaptif & Generatif</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="status-indicator" class="flex items-center gap-2 px-3 py-1 rounded-full bg-gray-100 border border-gray-200">
                    <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-400"></div>
                    <span id="status-text" class="text-xs font-bold text-gray-500">Connecting...</span>
                </div>
                <div id="user-info-display" class="hidden text-right">
                    <div id="display-name" class="font-bold text-sm text-blue-700">Peserta</div>
                    <div id="display-code" class="text-xs text-slate-500">Kode: -</div>
                </div>
                <div id="timer-display" class="hidden font-mono font-bold text-xl text-red-600 bg-red-50 px-3 py-1 rounded-md border border-red-200 shadow-inner">
                    60:00
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 flex flex-col items-center justify-center min-h-[80vh]">
        
        <!-- 1. LOGIN SCREEN -->
        <div id="login-screen" class="w-full max-w-md glass-panel p-8 rounded-2xl shadow-xl border border-white fade-in">
            <div class="text-center mb-6">
                <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-slate-800">Login Peserta</h2>
                <p class="text-slate-500 text-sm">Masuk untuk memulai ujian berbasis AI.</p>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-xl p-5 mb-6 text-center relative overflow-hidden">
                <div class="absolute top-0 right-0 bg-blue-500 text-white text-[10px] px-2 py-1 rounded-bl-lg font-bold">AUTO</div>
                <div class="grid grid-cols-2 gap-4 divide-x divide-blue-200">
                    <div>
                        <div class="text-xs text-slate-500 uppercase font-bold mb-1">Kode Peserta</div>
                        <div id="gen-code" class="text-2xl font-mono font-black text-blue-800 tracking-tight">...</div>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500 uppercase font-bold mb-1">Sandi</div>
                        <div id="gen-pass" class="text-2xl font-mono font-black text-blue-800 tracking-tight">...</div>
                    </div>
                </div>
            </div>

            <button onclick="app.handleLogin()" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                MASUK
            </button>
        </div>

        <!-- 2. DATA ENTRY & CONFIRMATION SCREEN -->
        <div id="confirmation-screen" class="hidden w-full max-w-4xl glass-panel p-8 rounded-2xl shadow-xl border border-white fade-in">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 border-b pb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Data Diri Peserta
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kode Peserta</label>
                        <input type="text" id="input-conf-code" class="w-full px-4 py-2 rounded-lg bg-slate-100 border border-slate-300 text-slate-600 font-bold" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Nama Peserta <span class="text-red-500">*</span></label>
                        <input type="text" id="input-name" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="Masukkan nama lengkap">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Jenis Kelamin <span class="text-red-500">*</span></label>
                        <select id="input-gender" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-white">
                            <option value="">-- Pilih Jenis Kelamin --</option>
                            <option value="Laki-laki">Laki-laki</option>
                            <option value="Perempuan">Perempuan</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">Tanggal Lahir <span class="text-red-500">*</span></label>
                        <input type="date" id="input-dob" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                    </div>
                </div>

                <div class="flex flex-col justify-center gap-6">
                    <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-center shadow-sm">
                        <div class="text-xs text-yellow-700 font-bold mb-2">TOKEN SERVER (AKTIF)</div>
                        <div id="token-display" class="text-4xl font-mono font-black text-slate-800 tracking-widest bg-white px-2 py-3 rounded-lg border border-slate-200 select-all">
                            -----
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border-2 border-slate-100">
                         <label class="block text-sm font-bold text-slate-700 mb-2 text-center">Salin Token Ujian <span class="text-red-500">*</span></label>
                         <input type="text" id="input-token" class="w-full px-4 py-3 rounded-lg border-2 border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition font-mono text-center text-xl tracking-widest uppercase placeholder:text-slate-300 placeholder:text-sm" placeholder="KETIK TOKEN DI SINI">
                         <p class="text-xs text-slate-400 mt-2 text-center">Ketik ulang token yang tampil di atas untuk memulai.</p>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex gap-3 border-t pt-6">
                <button onclick="location.reload()" class="flex-1 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-bold py-3 rounded-xl transition">
                    Batal
                </button>
                <button onclick="app.confirmData()" class="flex-[2] bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95">
                    KONFIRMASI & MULAI
                </button>
            </div>
        </div>

        <!-- 3. QUIZ SCREEN -->
        <div id="quiz-screen" class="hidden w-full max-w-5xl glass-panel rounded-2xl shadow-xl border border-white overflow-hidden fade-in flex flex-col">
            <div class="bg-slate-100 p-4 border-b border-slate-200 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span id="category-badge" class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold uppercase">Literasi Membaca</span>
                    <span id="level-badge" class="bg-gray-200 text-gray-700 px-2 py-1 rounded text-xs font-bold uppercase tracking-wider">Loading...</span>
                </div>
                <div class="text-sm font-bold text-slate-600" id="question-progress">Soal 1/30</div>
            </div>

            <div class="flex flex-col md:flex-row">
                <div class="flex-grow p-6 md:p-10">
                    <!-- Reading Text Area -->
                    <div id="question-text" class="mb-4"></div>
                    
                    <div id="options-container" class="grid grid-cols-1 gap-3"></div>
                    <div class="flex justify-between items-center mt-10 pt-6 border-t border-slate-100">
                        <button onclick="app.prevQuestion()" id="btn-prev" class="flex items-center gap-2 px-6 py-3 rounded-xl bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition disabled:opacity-50 disabled:cursor-not-allowed">
                            Soal Sebelumnya
                        </button>
                        <button onclick="app.nextQuestion()" id="btn-next" class="flex items-center gap-2 px-6 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 transition shadow-md hover:shadow-lg">
                            Soal Berikutnya
                        </button>
                    </div>
                </div>
                <div class="w-full md:w-64 bg-slate-50 border-l border-slate-200 p-4">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-3 text-center">Navigasi Soal</div>
                    <div id="nav-grid" class="grid grid-cols-5 gap-2"></div>
                    <button onclick="app.finishQuiz()" id="btn-submit-exam" class="mt-6 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg shadow transition">Selesai Ujian</button>
                </div>
            </div>
        </div>

        <!-- 4. RESULT & LEADERBOARD SCREEN -->
        <div id="result-screen" class="hidden w-full max-w-4xl glass-panel rounded-2xl shadow-xl border border-white p-6 md:p-8 fade-in text-center">
            <div class="inline-block p-4 rounded-full bg-green-100 text-green-600 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
             </div>
            <h2 class="text-3xl font-bold text-slate-800">Ujian Selesai!</h2>
            <p class="text-slate-500 mb-8">Nilai Anda telah disimpan ke server.</p>

            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-2xl p-6 mb-8 max-w-md mx-auto shadow-lg transform hover:scale-105 transition duration-300">
                <div class="text-sm font-semibold opacity-80 uppercase tracking-widest">Skor Perolehan</div>
                <div id="final-score" class="text-6xl font-extrabold my-2">0</div>
                <div class="text-sm opacity-90">Benar: <span id="correct-count">0</span> dari 30 Soal</div>
            </div>

            <!-- Tombol Aksi -->
            <div class="mt-8 flex gap-4 justify-center print:hidden">
                 <button onclick="document.getElementById('discussion-section').classList.toggle('hidden');" class="bg-blue-100 border border-blue-300 hover:bg-blue-200 text-blue-700 font-bold py-2 px-6 rounded-lg transition">Lihat Pembahasan</button>
                 <button onclick="window.print()" class="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-bold py-2 px-6 rounded-lg transition">Cetak Hasil & Pembahasan</button>
                <button onclick="location.reload()" class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-2 px-6 rounded-lg transition">Keluar / Login Ulang</button>
            </div>

            <!-- Bagian Pembahasan -->
            <div id="discussion-section" class="hidden mt-8 text-left border-t-2 border-slate-200 pt-8">
                <h3 class="font-bold text-2xl text-slate-800 mb-6 text-center">Pembahasan Soal</h3>
                <div id="discussion-content" class="space-y-6"></div>
            </div>
        </div>

    </main>

    <!-- Custom Modal -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform scale-100 transition-transform">
            <h3 class="text-lg font-bold text-slate-800 mb-2">Pemberitahuan</h3>
            <p id="modal-message" class="text-slate-600 mb-6 text-sm">Pesan...</p>
            <div class="flex justify-end gap-3" id="modal-actions"></div>
        </div>
    </div>

    <footer class="bg-white border-t border-slate-200 py-8 mt-12">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <div class="flex flex-col items-center">
                <p class="text-xs text-slate-500 leading-relaxed">
                    Pengembang: <strong class="text-slate-800 text-sm block mt-1">Yoyon Sugiyono, S.Pd., M.Pd., Gr.</strong>
                    <span class="block mt-1 font-medium text-slate-600">GPD Komunitas Belajar.id Kab. Sampang &bull; Guru Kelas di UPTD SDN Margantoko 2</span>
                    <span class="inline-flex items-center gap-1 mt-2 px-4 py-1.5 bg-slate-50 rounded-full border border-slate-200 text-slate-600 font-mono shadow-sm">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                        082331769605
                    </span>
                </p>
            </div>
        </div>
    </footer>

    <!-- APP LOGIC -->
    <script>
        const MANUAL_CONFIG = {
            apiKey: "AIzaSyDfEe7JwdlDQtToL2FZUkV3X_hj4N5gN1g",
            authDomain: "tka-indo-sd.firebaseapp.com",
            projectId: "tka-indo-sd",
            storageBucket: "tka-indo-sd.firebasestorage.app",
            messagingSenderId: "805759776077",
            appId: "1:805759776077:web:c02fd132f81cdf6b82f304"
        };

        let db, auth;
        let appId = 'tka-indo-sd-v1';
        const COLLECTION_NAME = 'tka_scores';

        async function initFirebase() {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');

            if (!window.firebaseModules) {
                await new Promise(resolve => window.addEventListener('firebaseModulesLoaded', resolve, { once: true }));
            }

            try {
                const { initializeApp, getAuth, signInAnonymously, getFirestore, collection, addDoc, serverTimestamp } = window.firebaseModules;
                let firebaseConfig = null;
                if (typeof window.__firebase_config !== 'undefined' && window.__firebase_config) {
                    firebaseConfig = JSON.parse(window.__firebase_config);
                    appId = typeof window.__app_id !== 'undefined' ? window.__app_id : appId;
                } else if (typeof MANUAL_CONFIG !== 'undefined' && MANUAL_CONFIG.apiKey) {
                    firebaseConfig = MANUAL_CONFIG;
                }
                if (!firebaseConfig) throw new Error("Konfigurasi Firebase tidak ditemukan.");
                const firebaseApp = initializeApp(firebaseConfig);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);
                await signInAnonymously(auth);
                console.log("Firebase Connected. User ID:", auth.currentUser?.uid);
                statusDot.className = "w-2 h-2 rounded-full bg-green-500";
                statusText.innerText = "Online";
                statusText.className = "text-xs font-bold text-green-500";
                if (typeof app !== 'undefined' && app.initCredentials) app.initCredentials();
            } catch (e) {
                console.warn("Masuk Mode Offline:", e.message);
                app.isOffline = true;
                statusDot.className = "w-2 h-2 rounded-full bg-orange-500";
                statusText.innerText = "Mode Offline";
                statusText.className = "text-xs font-bold text-orange-500";
                if (typeof app !== 'undefined' && app.initCredentials) app.initCredentials();
            }
        }

        const Utils = {
            randChoice: (arr) => arr[Math.floor(Math.random() * arr.length)],
            shuffle: (array) => {
                let currentIndex = array.length, randomIndex;
                while (currentIndex != 0) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
                }
                return array;
            }
        };

        // --- PROCEDURAL CONTENT GENERATION (AI ENGINE) ---
        // Engine ini bertugas membuat teks dan soal baru berdasarkan kisi-kisi
        
        const ContentEngine = {
            // Data untuk Fiksi (Fabel)
            fictionData: {
                chars: [
                    { name: "Kancil", trait: "cerdik", action: "mengelabui" },
                    { name: "Gajah", trait: "sombong", action: "memamerkan kekuatan" },
                    { name: "Semut", trait: "pekerja keras", action: "mengumpulkan makanan" },
                    { name: "Kura-kura", trait: "sabar", action: "berjalan perlahan" },
                    { name: "Monyet", trait: "jahil", action: "mencuri pisang" }
                ],
                settings: ["hutan rimba", "tepi sungai", "padang rumput yang luas", "bukit berbatu"],
                plots: [
                    { conflict: "memperebutkan makanan", resolution: "berbagi bersama" },
                    { conflict: "terjebak dalam lubang", resolution: "saling tolong menolong" },
                    { conflict: "mengejek yang lemah", resolution: "yang lemah membuktikan kemampuannya" }
                ],
                generate: function() {
                    const char1 = Utils.randChoice(this.chars);
                    let char2 = Utils.randChoice(this.chars);
                    while(char1.name === char2.name) char2 = Utils.randChoice(this.chars); // Ensure different chars
                    const place = Utils.randChoice(this.settings);
                    const plot = Utils.randChoice(this.plots);

                    const title = `Kisah ${char1.name} dan ${char2.name}`;
                    const text = `Di sebuah ${place}, hiduplah seekor ${char1.name} yang terkenal ${char1.trait}. Suatu hari, ia sedang ${char1.action} ketika bertemu dengan ${char2.name}.\n\n${char2.name} adalah hewan yang berbeda, namun hari itu mereka terlibat masalah. Mereka ${plot.conflict}. Suasana menjadi tegang. ${char1.name} berusaha mencari jalan keluar dengan sifatnya yang ${char1.trait}.\n\nAkhirnya, mereka menyadari kesalahan masing-masing. Mereka memutuskan untuk ${plot.resolution}. Sejak saat itu, mereka hidup rukun di ${place}.`;

                    // Generate Questions based on metadata
                    const questions = [
                        {
                            q: `Siapakah tokoh dalam cerita yang memiliki sifat ${char1.trait}?`,
                            a: char1.name,
                            opts: [char1.name, char2.name, "Singa", "Burung Hantu"],
                            level: "LOTS",
                            exp: `Dalam teks disebutkan: "...hiduplah seekor ${char1.name} yang terkenal ${char1.trait}."`
                        },
                        {
                            q: `Di manakah latar tempat cerita tersebut?`,
                            a: place,
                            opts: this.settings, // All settings as options
                            level: "LOTS",
                            exp: `Kalimat pertama teks menyebutkan: "Di sebuah ${place}..."`
                        },
                        {
                            q: `Apa pesan moral yang dapat diambil dari cerita di atas?`,
                            a: `Kita harus ${plot.resolution}.`,
                            opts: [`Kita harus ${plot.conflict}.`, `Kita harus ${plot.resolution}.`, "Kita harus menghindari hutan.", "Kita harus menjadi kuat."],
                            level: "HOTS",
                            exp: `Di akhir cerita, tokoh memutuskan untuk ${plot.resolution}, yang mengajarkan kita tentang kerukunan.`
                        }
                    ];
                    return { title, text, questions: Utils.shuffle(questions)[0] }; // Return 1 random question per text generation
                }
            },

            // Data untuk Teks Informasi
            infoData: {
                topics: [
                    { title: "Manfaat Minum Air Putih", content: "Air putih sangat penting bagi tubuh. Tubuh manusia sebagian besar terdiri dari air. Minum air membantu menjaga suhu tubuh, melancarkan pencernaan, dan mencegah dehidrasi. Kurang minum dapat menyebabkan sakit kepala dan lemas.", key: "mencegah dehidrasi" },
                    { title: "Pentingnya Sarapan", content: "Sarapan adalah waktu makan terpenting. Sarapan memberikan energi untuk memulai hari. Orang yang sarapan cenderung lebih fokus saat belajar atau bekerja. Menu sarapan sehat sebaiknya mengandung karbohidrat dan protein.", key: "memberikan energi" },
                    { title: "Menjaga Kebersihan Gigi", content: "Gigi harus disikat minimal dua kali sehari. Sisa makanan yang menempel dapat menjadi sarang kuman. Kuman menghasilkan asam yang membuat gigi berlubang. Selain menyikat gigi, kita juga harus mengurangi makanan manis.", key: "mencegah gigi berlubang" }
                ],
                generate: function() {
                    const topic = Utils.randChoice(this.topics);
                    
                    // Generate Question
                    const questions = [
                        {
                            q: `Apa gagasan pokok dari teks berjudul "${topic.title}"?`,
                            a: topic.title.replace("Manfaat", "Pentingnya").replace("Pentingnya", "Manfaat") + " bagi kesehatan.", 
                            // Simple logic to create slightly different answer text
                            opts: [
                                topic.title.replace("Manfaat", "Pentingnya").replace("Pentingnya", "Manfaat") + " bagi kesehatan.",
                                "Cara membuat makanan enak.",
                                "Bahaya tidur terlalu malam.",
                                "Jenis-jenis olahraga pagi."
                            ],
                            level: "MOTS",
                            exp: `Teks membahas secara keseluruhan tentang ${topic.title}.`
                        },
                        {
                            q: `Berdasarkan teks, apa akibat jika kita mengabaikan hal tersebut?`,
                            a: "Dapat menyebabkan gangguan kesehatan.",
                            opts: ["Tubuh menjadi lebih kuat.", "Dapat menyebabkan gangguan kesehatan.", "Pikiran menjadi lebih tenang.", "Gigi menjadi lebih putih."],
                            level: "MOTS",
                            exp: "Teks menjelaskan dampak negatif seperti dehidrasi, kurang fokus, atau gigi berlubang."
                        }
                    ];
                    
                    // Specific logic for LOTS extraction
                    const specificQ = {
                        q: `Salah satu manfaat yang disebutkan dalam teks adalah...`,
                        a: topic.key,
                        opts: [topic.key, "membuat mengantuk", "menambah berat badan", "membuat kulit gatal"],
                        level: "LOTS",
                        exp: `Teks secara tersurat menyebutkan manfaat: ${topic.key}.`
                    };
                    questions.push(specificQ);

                    return { title: topic.title, text: `<b>${topic.title}</b>\n\n${topic.content}`, questions: Utils.shuffle(questions)[0] };
                }
            }
        };

        const QuestionGenerator = {
            generateBatch: (count) => {
                const results = [];
                for(let i=0; i<count; i++) {
                    // 50:50 chance between Fiction and Info
                    const isFiction = Math.random() > 0.5;
                    let data;
                    if(isFiction) {
                        data = ContentEngine.fictionData.generate();
                        data.cat = "Fiksi (Fabel)";
                    } else {
                        data = ContentEngine.infoData.generate();
                        data.cat = "Teks Informasi";
                    }
                    
                    // Format output
                    const formattedQ = {
                        q: `<div class="reading-text">${data.text}</div><div class="font-bold text-lg text-slate-800">${data.questions.q}</div>`,
                        ans: data.questions.a,
                        opts: Utils.shuffle(data.questions.opts),
                        level: data.questions.level,
                        cat: data.cat,
                        exp: data.questions.exp,
                        competency: isFiction ? "Memahami Teks Sastra" : "Memahami Teks Informasi"
                    };
                    results.push(formattedQ);
                }
                return results;
            }
        };

        const app = {
            user: { code: '', name: '', gender: '', dob: '', token: '' },
            questions: [],
            answers: [],
            currIdx: 0,
            timer: null,
            time: 3600,
            isOffline: false,
            generatedCreds: { code: '', pass: '' },

            showModal: (msg, type = 'alert', callback = null) => {
                const modal = document.getElementById('custom-modal');
                const msgEl = document.getElementById('modal-message');
                const actionsEl = document.getElementById('modal-actions');
                msgEl.innerHTML = msg;
                actionsEl.innerHTML = '';
                if (type === 'confirm') {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = "px-4 py-2 rounded-lg bg-slate-200 text-slate-700 font-bold hover:bg-slate-300";
                    cancelBtn.innerText = "Batal";
                    cancelBtn.onclick = () => modal.classList.add('hidden');
                    const okBtn = document.createElement('button');
                    okBtn.className = "px-4 py-2 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700";
                    okBtn.innerText = "Ya, Yakin";
                    okBtn.onclick = () => { modal.classList.add('hidden'); if (callback) callback(); };
                    actionsEl.appendChild(cancelBtn);
                    actionsEl.appendChild(okBtn);
                } else {
                    const okBtn = document.createElement('button');
                    okBtn.className = "px-4 py-2 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700";
                    okBtn.innerText = "OK";
                    okBtn.onclick = () => { modal.classList.add('hidden'); if (callback) callback(); };
                    actionsEl.appendChild(okBtn);
                }
                modal.classList.remove('hidden');
            },

            initCredentials: () => {
                const codes = ['TKA-001', 'TKA-042', 'SISWA-88', 'PESERTA-12', 'BINTANG-07'];
                app.generatedCreds.code = `${codes[Math.floor(Math.random() * codes.length)]}`;
                app.generatedCreds.pass = Math.random().toString(36).slice(-6).toUpperCase();
                const codeElem = document.getElementById('gen-code');
                const passElem = document.getElementById('gen-pass');
                if (codeElem) codeElem.innerText = app.generatedCreds.code;
                if (passElem) passElem.innerText = app.generatedCreds.pass;
            },

            handleLogin: () => {
                app.user.code = app.generatedCreds.code;
                app.user.token = Math.random().toString(36).substring(2, 7).toUpperCase();
                document.getElementById('input-conf-code').value = app.user.code;
                document.getElementById('token-display').innerText = app.user.token;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('confirmation-screen').classList.remove('hidden');
            },

            confirmData: () => {
                const name = document.getElementById('input-name').value.trim();
                const gender = document.getElementById('input-gender').value;
                const dob = document.getElementById('input-dob').value;
                const manualToken = document.getElementById('input-token').value.trim().toUpperCase();
                if (!name || !gender || !dob) {
                    app.showModal("Mohon lengkapi Nama, Jenis Kelamin, dan Tanggal Lahir!", 'alert');
                    return;
                }
                if (manualToken !== app.user.token) {
                    app.showModal("Token Ujian tidak sesuai! Mohon periksa kembali token yang tertera.", 'alert');
                    return;
                }
                app.user.name = name;
                app.user.gender = gender;
                app.user.dob = dob;
                document.getElementById('confirmation-screen').classList.add('hidden');
                document.getElementById('quiz-screen').classList.remove('hidden');
                document.getElementById('user-info-display').classList.remove('hidden');
                document.getElementById('display-name').innerText = app.user.name;
                document.getElementById('display-code').innerText = app.user.code;
                document.getElementById('timer-display').classList.remove('hidden');
                app.startQuiz();
            },

            generateQuestions: () => {
                // Generate 30 soal unik menggunakan AI Engine (Procedural Generation)
                app.questions = QuestionGenerator.generateBatch(30);
                app.answers = new Array(30).fill(null);
            },

            startQuiz: () => {
                app.generateQuestions();
                app.renderNav();
                app.loadQ(0);
                app.timer = setInterval(() => {
                    app.time--;
                    const m = Math.floor(app.time/60);
                    const s = app.time%60;
                    document.getElementById('timer-display').innerText = `${m}:${s<10?'0'+s:s}`;
                    if(app.time <= 0) app.finishQuiz();
                }, 1000);
            },

            loadQ: (idx) => {
                app.currIdx = idx;
                const q = app.questions[idx];
                document.getElementById('question-progress').innerText = `Soal ${idx+1}/30`;
                document.getElementById('category-badge').innerText = q.competency || q.cat;
                
                const lvlBadge = document.getElementById('level-badge');
                lvlBadge.innerText = q.level;
                
                if(q.level === 'LOTS') {
                    lvlBadge.className = "bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold uppercase tracking-wider border border-green-200";
                } else if(q.level === 'MOTS') {
                    lvlBadge.className = "bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold uppercase tracking-wider border border-yellow-200";
                } else {
                    lvlBadge.className = "bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold uppercase tracking-wider border border-red-200";
                }

                document.getElementById('question-text').innerHTML = q.q;
                
                const opts = document.getElementById('options-container');
                opts.innerHTML = '';
                const labels = ['A', 'B', 'C', 'D'];
                q.opts.forEach((opt, i) => {
                    const btn = document.createElement('button');
                    const isSel = app.answers[idx] === opt;
                    const label = labels[i] || '';
                    btn.className = `w-full text-left p-3 rounded-lg border-2 transition flex items-center gap-3 ${isSel ? 'border-blue-500 bg-blue-50' : 'border-slate-200 hover:border-blue-300 bg-white'}`;
                    btn.innerHTML = `<div class="flex-shrink-0 h-8 w-8 rounded-full ${isSel ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-500'} flex items-center justify-center font-bold text-sm border ${isSel ? 'border-blue-600' : 'border-slate-300'}">${label}</div><span class="text-slate-700 font-medium">${opt}</span>`;
                    btn.onclick = () => { app.answers[idx] = opt; app.loadQ(idx); app.updateNav(); };
                    opts.appendChild(btn);
                });
                
                const prevBtn = document.getElementById('btn-prev');
                const nextBtn = document.getElementById('btn-next');
                if(prevBtn) prevBtn.disabled = idx === 0;
                if(nextBtn) {
                    nextBtn.onclick = null; 
                    if(idx === 29) {
                        nextBtn.innerHTML = `Selesai Ujian <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
                        nextBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        nextBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                        nextBtn.onclick = () => app.finishQuiz(); 
                    } else {
                        nextBtn.innerHTML = `Soal Berikutnya <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>`;
                        nextBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                        nextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        nextBtn.onclick = () => app.nextQuestion();
                    }
                }
                app.updateNav();
            },

            prevQuestion: () => { if(app.currIdx > 0) app.loadQ(app.currIdx - 1); },
            nextQuestion: () => { if(app.currIdx < 29) app.loadQ(app.currIdx + 1); },

            renderNav: () => {
                const grid = document.getElementById('nav-grid');
                grid.innerHTML = '';
                for(let i=0; i<30; i++) {
                    const btn = document.createElement('button');
                    btn.id = `nav-${i}`;
                    btn.innerText = i+1;
                    btn.className = `h-8 w-8 rounded text-xs font-bold bg-slate-200 text-slate-600`;
                    btn.onclick = () => app.loadQ(i);
                    grid.appendChild(btn);
                }
            },

            updateNav: () => {
                for(let i=0; i<30; i++) {
                    const btn = document.getElementById(`nav-${i}`);
                    btn.className = `h-8 w-8 rounded text-xs font-bold transition ${i === app.currIdx ? 'ring-2 ring-blue-500 bg-white' : (app.answers[i] ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-600')}`;
                }
            },

            finishQuiz: () => {
                app.showModal("Apakah Anda yakin ingin menyelesaikan ujian ini? Jawaban tidak dapat diubah setelah ini.", 'confirm', async () => {
                    clearInterval(app.timer);
                    let correct = 0;
                    
                    const discussionContent = document.getElementById('discussion-content');
                    discussionContent.innerHTML = '';

                    app.questions.forEach((q, i) => { 
                        const isCorrect = app.answers[i] === q.ans;
                        if(isCorrect) correct++; 
                        
                        // Generate Discussion Item HTML
                        const item = document.createElement('div');
                        item.className = `page-break mb-6 p-4 border rounded-lg ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`;
                        item.innerHTML = `
                            <div class="font-bold text-slate-700 mb-2 flex justify-between">
                                <span>Soal ${i+1} (${q.level})</span>
                                <span class="${isCorrect ? 'text-green-600' : 'text-red-600'} text-xs font-bold uppercase border px-2 rounded ${isCorrect ? 'border-green-300 bg-green-100' : 'border-red-300 bg-red-100'}">${isCorrect ? 'Benar' : 'Salah'}</span>
                            </div>
                            <div class="mb-3 text-sm text-slate-800">${q.q}</div>
                            <div class="text-sm grid grid-cols-1 md:grid-cols-2 gap-2 mb-3">
                                <p class="bg-white p-2 rounded border border-slate-200"><strong>Jawaban Anda:</strong> <span class="${isCorrect ? 'text-green-700 font-bold' : 'text-red-700 font-bold'}">${app.answers[i] || 'Tidak dijawab'}</span></p>
                                <p class="bg-white p-2 rounded border border-slate-200"><strong>Kunci Jawaban:</strong> <span class="text-green-700 font-bold">${q.ans}</span></p>
                            </div>
                            <div class="mt-2 p-3 bg-white rounded border border-slate-300 text-sm text-slate-600 shadow-sm">
                                <strong class="text-blue-600 block mb-1">Pembahasan:</strong>
                                ${q.exp}
                            </div>
                        `;
                        discussionContent.appendChild(item);
                    });

                    const score = Math.round((correct/30) * 100);
                    document.getElementById('quiz-screen').classList.add('hidden');
                    document.getElementById('timer-display').classList.add('hidden');
                    document.getElementById('result-screen').classList.remove('hidden');
                    document.getElementById('final-score').innerText = score;
                    document.getElementById('correct-count').innerText = correct;
                    
                    if (!app.isOffline && db && auth.currentUser) {
                        await app.saveScore(score);
                        app.loadLeaderboard();
                    } else {
                        // Offline mode handling if needed
                    }
                });
            },

            saveScore: async (score) => {
                if(!db || !auth.currentUser) return;
                try {
                    const { collection, addDoc, serverTimestamp } = window.firebaseModules;
                    let collectionRef;
                    if (typeof window.__app_id !== 'undefined') {
                         collectionRef = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                    } else {
                         collectionRef = collection(db, COLLECTION_NAME);
                    }
                    await addDoc(collectionRef, { 
                        code: app.user.code, 
                        name: app.user.name, 
                        score: score, 
                        timestamp: serverTimestamp() 
                    });
                } catch (e) { console.error("Save Error", e); }
            },

            loadLeaderboard: () => {
                if(!db) return;
                const { collection, query, orderBy, limit, onSnapshot } = window.firebaseModules;
                let collectionRef;
                if (typeof window.__app_id !== 'undefined') {
                     collectionRef = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                } else {
                     collectionRef = collection(db, COLLECTION_NAME);
                }
                const q = query(collectionRef, orderBy("score", "desc"), limit(20));
                
                // Tambahkan pengecekan elemen
                const loadingEl = document.getElementById('loading-leaderboard');
                if (loadingEl) loadingEl.classList.remove('hidden');
                
                onSnapshot(q, (snapshot) => {
                    const tbody = document.getElementById('leaderboard-body');
                    if (!tbody) return; // Guard clause
                    
                    tbody.innerHTML = '';
                    let rank = 1;
                    if(snapshot.empty) { tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center">Belum ada data.</td></tr>`; }
                    snapshot.forEach((doc) => {
                        const d = doc.data();
                        const isMe = d.name === app.user.name && d.code === app.user.code;
                        const row = `<tr class="${isMe ? 'bg-yellow-50 border-l-4 border-yellow-400' : 'hover:bg-slate-50'} transition"><td class="px-6 py-4 font-bold text-slate-500">${rank++}</td><td class="px-6 py-4 font-semibold ${isMe ? 'text-blue-700' : 'text-slate-700'}">${d.name} ${isMe ? '(Anda)' : ''}</td><td class="px-6 py-4 text-slate-500 text-xs">${d.code}</td><td class="px-6 py-4 text-right font-bold text-blue-600">${d.score}</td></tr>`;
                        tbody.innerHTML += row;
                    });
                    if (loadingEl) loadingEl.classList.add('hidden');
                }, (error) => {
                    console.error("Leaderboard Error:", error);
                    const tbody = document.getElementById('leaderboard-body');
                    if (tbody) tbody.innerHTML = `<tr><td colspan="4" class="text-center text-red-500 text-xs">Gagal memuat data (Izin ditolak atau Offline).<br>Cek Console Log.</td></tr>`;
                });
            }
        };

        window.app = app;
        window.addEventListener('load', initFirebase);
    </script>
</body>
</html>
